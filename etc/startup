#!/usr/bin/env bash

set -e

USER=root
if [[ $(stat -c "%u" /var/www) != 0 ]]; then
	useradd -s /bin/bash -u $(stat -c "%u" /var/www) -o -m ant
	chown ant /var/www
	USER=ant
fi

su ${USER} -c "composer config --global github-oauth.github.com ${GITHUB_KEY}"
su ${USER} -c "composer config --global --auth gitlab-token.git.antstudio.cz ${GITLAB_KEY}"

su ${USER} -c "mkdir -p /var/www/log"
su ${USER} -c "touch /var/www/log/apache.access.log"
su ${USER} -c "touch /var/www/log/apache.error.log"

echo "" > /var/www/log/apache.access.log
echo "" > /var/www/log/apache.error.log

export APACHE_RUN_USER=${USER}
export APACHE_RUN_GROUP=${USER}

#if [ -f /var/www/package.json ]; then
#	apache2ctl start
#	su ${USER} -c "npm start"
#	apache2ctl stop
#fi

exec apache2-foreground
